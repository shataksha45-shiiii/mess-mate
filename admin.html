<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mess Mate Admin üçΩÔ∏è</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
  background:linear-gradient(135deg,#FFF5E1 0%,#FFE5B4 50%,#FFDAB9 100%);
  min-height:100vh;overflow-x:hidden;
}
header{
  background:linear-gradient(135deg,#FF6B6B 0%,#FF8E53 100%);
  color:#fff;padding:14px 20px;display:flex;justify-content:space-between;
  align-items:center;position:sticky;top:0;z-index:10;box-shadow:0 3px 10px rgba(0,0,0,.15)
}
header h1{font-weight:900;font-size:1.3rem;text-shadow:1px 1px 3px rgba(0,0,0,.2)}
header button{
  background:#fff;color:#FF6B6B;border:none;padding:8px 16px;border-radius:20px;
  font-weight:800;cursor:pointer
}
#loginPage,#dashboard{display:none}
#loginPage{
  display:flex;justify-content:center;align-items:center;min-height:100vh;
}
.login-box{
  background:linear-gradient(135deg,#FF6B6B,#FF8E53);
  padding:40px 30px;border-radius:28px;width:90%;max-width:420px;
  text-align:center;box-shadow:0 20px 50px rgba(255,107,107,.4)
}
.login-box h2{color:#fff;font-size:2rem;margin-bottom:10px;font-weight:900}
.login-box p{color:#fff;font-weight:600;margin-bottom:20px}
.google-btn{
  background:#fff;color:#FF6B6B;border:none;padding:14px 20px;
  border-radius:50px;font-weight:800;font-size:1rem;width:100%;
  box-shadow:0 10px 25px rgba(0,0,0,.15);cursor:pointer
}
.google-btn:hover{transform:translateY(-4px)}
.error-message{background:#fff;color:#FF6B6B;padding:10px;margin-top:12px;border-radius:10px;display:none}
main{padding:20px}
.order-card{
  background:#fff;border-radius:20px;box-shadow:0 6px 20px rgba(0,0,0,.08);
  padding:16px;margin-bottom:16px;transition:.25s;overflow:hidden
}
.order-card:hover{transform:translateY(-4px)}
.order-head{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
.order-email{font-weight:800;color:#FF6B6B;font-size:.95rem}
.order-id{font-size:.8rem;color:#636E72}
.order-items{margin:10px 0;padding-left:14px}
.order-items li{font-weight:600;color:#2D3436;line-height:1.5}
.order-total{font-weight:900;color:#00B894;margin:6px 0}
.status-btns{display:flex;gap:8px;flex-wrap:wrap}
.status-btns button{
  flex:1;min-width:100px;padding:10px;border:none;border-radius:14px;
  font-weight:700;cursor:pointer
}
.pending{background:#FFEAA7;color:#2D3436}
.preparing{background:#74B9FF;color:#fff}
.delivered{background:#00B894;color:#fff}
@media(max-width:600px){
  .order-head{flex-direction:column;align-items:flex-start}
  header h1{font-size:1.1rem}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage">
  <div class="login-box">
    <h2>üçΩÔ∏è Mess Mate Admin</h2>
    <p>Sign in with your admin Google account</p>
    <button class="google-btn" id="signInBtn">Sign in with Google</button>
    <div class="error-message" id="errorMessage"></div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
  <header>
    <h1>Admin Dashboard</h1>
    <button id="logoutBtn">Logout</button>
  </header>
  <main>
    <h2 style="margin-bottom:12px;color:#FF6B6B">Incoming Orders</h2>
    <div id="ordersContainer"></div>
  </main>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
// ---------- CONFIG ----------
const firebaseConfig = {
  apiKey: "AIzaSyBD5-K6SdhPlbGIwX9fFEruf_1nU5QFt8M",
  authDomain: "mess-mate-2.firebaseapp.com",
  projectId: "mess-mate-2",
  storageBucket: "mess-mate-2.firebasestorage.app",
  messagingSenderId: "39989606423",
  appId: "1:39989606423:web:b16c5cbd285523de888452",
  measurementId: "G-V59NZ0Y3K8"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ---------- ADMIN EMAILS ----------
const allowedEmails = [
  "meenakshi6507@gmail.com",
  "piyushgupta6190@gmail.com",
  "abhijeetthkr1122@gmail.com",
  "aarnatiwari1208@gmail.com",
  "ishaanpatel497@gmail.com",
  "shataksha45@gmail.com"
];

// ---------- ELEMENTS ----------
const loginPage = document.getElementById("loginPage");
const dashboard = document.getElementById("dashboard");
const signInBtn = document.getElementById("signInBtn");
const logoutBtn = document.getElementById("logoutBtn");
const ordersContainer = document.getElementById("ordersContainer");
const errorMessage = document.getElementById("errorMessage");

// ---------- AUTH ----------
signInBtn.addEventListener("click", async () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    await auth.signInWithPopup(provider);
  } catch (e) {
    errorMessage.textContent = "Sign-in failed: " + e.message;
    errorMessage.style.display = "block";
  }
});

logoutBtn.addEventListener("click", () => auth.signOut());

auth.onAuthStateChanged(user => {
  if (user) {
    const email = user.email;
    const isAdmin = email.endsWith("@iiitnr.edu.in") || allowedEmails.includes(email);
    if (isAdmin) {
      loginPage.style.display = "none";
      dashboard.style.display = "block";
      loadOrders();
    } else {
      auth.signOut();
      errorMessage.textContent = "Unauthorized account";
      errorMessage.style.display = "block";
    }
  } else {
    dashboard.style.display = "none";
    loginPage.style.display = "flex";
  }
});

// ---------- LOAD ORDERS ----------
function loadOrders() {
  ordersContainer.innerHTML = "<p style='color:#636E72;font-weight:600'>Loading orders‚Ä¶</p>";

  db.collection("orders")
    .orderBy("createdAt", "desc")
    .onSnapshot(snapshot => {
      if (snapshot.empty) {
        ordersContainer.innerHTML = "<p style='color:#B2BEC3;font-weight:600'>No orders yet.</p>";
        return;
      }
      ordersContainer.innerHTML = "";

      snapshot.forEach(doc => {
        const o = doc.data();
        const orderId = doc.id; // Ensure we capture it here
        const items = (o.items || []).map(it => `<li>${it.name} √ó ${it.quantity}</li>`).join("");

        const card = document.createElement("div");
        card.className = "order-card";
        card.innerHTML = `
          <div class="order-head">
            <div class="order-email">${o.userEmail || "Unknown User"}</div>
            <div class="order-id">${orderId}</div>
          </div>
          <ul class="order-items">${items}</ul>
          <div class="order-total">Total ‚Çπ${o.total || 0}</div>
          <div style="margin-bottom:6px;font-weight:700;color:#636E72">Status: <span style="color:#FF6B6B">${o.status || "Pending"}</span></div>
          <div class="status-btns">
            <button class="pending">Pending</button>
            <button class="preparing">Preparing</button>
            <button class="delivered">Delivered</button>
          </div>
        `;

        // Buttons now properly update the status
        const [bPending, bPrep, bDel] = card.querySelectorAll("button");
        bPending.addEventListener("click", () => updateStatus(orderId, "Pending"));
        bPrep.addEventListener("click", () => updateStatus(orderId, "Preparing"));
        bDel.addEventListener("click", () => updateStatus(orderId, "Delivered"));

        ordersContainer.appendChild(card);
      });
    }, err => {
      console.error("Error fetching orders:", err);
      ordersContainer.innerHTML = "<p style='color:#E17055;font-weight:700'>Failed to load orders. Check console.</p>";
    });
}

// ---------- UPDATE STATUS ----------
async function updateStatus(orderId, newStatus) {
  try {
    await db.collection("orders").doc(orderId).update({
      status: newStatus,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    console.log(`Order ${orderId} updated to ${newStatus}`);
  } catch (err) {
    console.error("Update failed", err);
    alert("Failed to update order: " + err.message);
  }
}
</script>
</body>
</html>